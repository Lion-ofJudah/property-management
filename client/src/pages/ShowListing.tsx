import { useState, useEffect } from "react";
import { useParams } from "react-router-dom";
import ImageGrid from "../components/ImageGrid";

interface Listing {
  _id: string;
  imageUrls: string[];
  title: string;
  description: string;
  address: string;
  bedrooms: number;
  bathrooms: number;
  regularPrice: number;
  discountPrice: number;
  type: string;
  parking: boolean;
  furnished: boolean;
  userRef: string;
}

interface User {
  _id: string;
  userName: string;
  avatar: string;
}

export default function ShowListing() {
  const [listing, setListing] = useState<Listing>({
    _id: "",
    imageUrls: [],
    title: "",
    description: "",
    address: "",
    bedrooms: 1,
    bathrooms: 1,
    regularPrice: 0,
    discountPrice: 0,
    type: "rent",
    parking: false,
    furnished: false,
    userRef: "",
  });
  const [user, setUser] = useState<User>({
    _id: "",
    userName: "",
    avatar: "",
  });
  const params = useParams();

  console.log(listing);
  console.log(user);

  useEffect(() => {
    const fetchListing = async () => {
      const listingId = params.listingId;
      const res = await fetch(`/api/listing/get/${listingId}`, {
        method: "GET",
      });

      const data: Listing = await res.json();

      if (!data) {
        console.log("Failed to fetch listing");
        return;
      }
      setListing(data);
    };

    fetchListing();
  }, [params.listingId]);

  useEffect(() => {
    const fetchOwner = async () => {
      const userId = listing.userRef;
      const res = await fetch(`/api/user/get-user/${userId}`, {
        method: "GET",
      });

      const data: User = await res.json();

      if (!data) {
        console.log("Failed to load user!");
        return;
      }
      setUser(data);
    };
    fetchOwner();
  }, [listing.userRef]);

  return (
    <div className="flex flex-col pt-6 px-8 min-h-[100vh-80px] w-full lg:w-3/5 mx-auto">
      <div>
        <p className="font-bold text-xl sm:text-3xl">{listing.title}</p>
      </div>
      <ImageGrid imageUrls={listing.imageUrls} />
      <div className="sm:grid sm:grid-cols-3 gap-4">
        <div className="sm:col-span-2 flex flex-col flex-1">
          <div className="mt-2 sm:mt-9 mb-0 sm:mb-2">
            <p className="font-medium text-lg sm:text-2xl">{listing.address}</p>
            <p className="text-gray-500">For {listing.type}</p>
          </div>
          <span className="my-2 sm:mt-6 border-t"></span>
          <div className="flex my-2 gap-4 items-center">
            <img
              src={user.avatar}
              alt="profile"
              className="size-10 sm:size-14 rounded-full cursor-pointer border"
            />
            <p className="text-md sm:text-xl">
              Property of <span className="font-bold">{user.userName}</span>
            </p>
          </div>
          <span className="my-2 border-t"></span>
        </div>
        <div className="flex items-center justify-center sm:justify-end mt-2 sm:mt-4 text-center">
          <p className="flex items-center flex-wrap  justify-center font-medium cursor-pointer text-lg sm:text-2xl border py-5 sm:py-16 px-5 rounded-3xl shadow-sm hover:shadow-md">
            Birr{" "}
            <span className="text-accent ml-2">{listing.regularPrice}</span>
            {listing.type === "rent" && "/month"}
          </p>
        </div>
      </div>
      <div className="flex flex-col gap-4 my-8">
        {listing.furnished && (
          <div className="flex w-max justify-center items-center gap-3">
            <span>
              <svg
                className="size-6 fill-fontColor -mt-1"
                viewBox="0 0 50 50"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path d="M13.9375 12C8.488281 12 4.03125 16.425781 4.03125 21.875L4.03125 24.15625C1.742188 24.734375 0.03125 26.824219 0.03125 29.28125C0.03125 31.496094 1.460938 33.320313 3.40625 34.09375L5.84375 40.4375L5.875 40.53125L5.90625 40.53125C6.148438 41.28125 6.566406 41.875 7.0625 42.34375L5.3125 45.875C4.613281 47.269531 5.167969 48.988281 6.5625 49.6875C6.964844 49.890625 7.414063 50 7.84375 50C8.886719 50 9.910156 49.425781 10.40625 48.4375L12.59375 44L37.40625 44L39.59375 48.4375C40.089844 49.425781 41.113281 50 42.15625 50C42.585938 50 43.035156 49.890625 43.4375 49.6875C44.832031 48.988281 45.386719 47.269531 44.6875 45.875L42.9375 42.34375C43.433594 41.875 43.851563 41.28125 44.09375 40.53125L44.125 40.53125L44.15625 40.4375L46.59375 34.09375C48.539063 33.320313 49.96875 31.496094 49.96875 29.28125C49.96875 26.824219 48.257813 24.734375 45.96875 24.15625L45.96875 21.875C45.96875 16.425781 41.511719 12 36.0625 12 Z M 13.9375 14L36.0625 14C40.429688 14 43.96875 17.507813 43.96875 21.875L43.96875 24.0625C42.0625 24.332031 40.492188 25.628906 39.8125 27.375L39.78125 27.375L38.15625 31.09375C38.023438 31.050781 37.945313 31.019531 37.78125 30.96875C37.027344 30.742188 35.960938 30.445313 34.6875 30.15625C32.136719 29.578125 28.722656 29 25.125 29C21.527344 29 18.046875 29.574219 15.4375 30.15625C14.132813 30.445313 13.027344 30.738281 12.25 30.96875C12.074219 31.019531 11.984375 31.050781 11.84375 31.09375L10.3125 27.65625L10.28125 27.65625C9.671875 25.769531 8.035156 24.347656 6.03125 24.0625L6.03125 21.875C6.03125 17.507813 9.570313 14 13.9375 14 Z M 5.3125 26C6.800781 26 8.039063 26.984375 8.4375 28.34375L8.4375 28.40625L8.46875 28.46875L10.40625 32.75L10.875 33.78125L11.71875 33.25L11.8125 33.1875C11.828125 33.175781 11.8125 33.207031 11.84375 33.1875C11.882813 33.171875 11.914063 33.175781 11.96875 33.15625C12.167969 33.089844 12.445313 32.984375 12.8125 32.875C13.550781 32.660156 14.617188 32.375 15.875 32.09375C18.386719 31.535156 21.742188 31 25.125 31C28.507813 31 31.800781 31.539063 34.25 32.09375C35.472656 32.371094 36.476563 32.660156 37.1875 32.875C37.542969 32.984375 37.839844 33.058594 38.03125 33.125C38.125 33.15625 38.175781 33.203125 38.21875 33.21875L38.25 33.21875L39.125 33.75L39.59375 32.71875L41.625 28.1875L41.625 28.15625L41.65625 28.125C42.121094 26.882813 43.277344 26 44.6875 26C46.503906 26 47.96875 27.464844 47.96875 29.28125C47.96875 30.789063 46.945313 32.023438 45.5625 32.40625L45.0625 32.53125L44.90625 33L42.25 39.8125L42.25 39.84375L42.21875 39.875C41.925781 40.894531 41.0625 41.421875 40.09375 41.71875C39.261719 41.976563 38.601563 42 38.40625 42C38.148438 41.886719 37.851563 41.886719 37.59375 42L12.375 42C12.132813 41.902344 11.867188 41.902344 11.625 42C11.460938 42 10.765625 41.984375 9.90625 41.71875C8.9375 41.421875 8.074219 40.894531 7.78125 39.875L7.75 39.84375L7.75 39.78125L5.09375 33L4.9375 32.53125L4.4375 32.40625C3.050781 32.023438 2.03125 30.789063 2.03125 29.28125C2.03125 27.464844 3.496094 26 5.3125 26 Z M 8.78125 43.40625C8.957031 43.476563 9.144531 43.574219 9.3125 43.625C9.714844 43.75 10.089844 43.820313 10.4375 43.875L8.59375 47.53125C8.441406 47.835938 8.15625 48 7.84375 48C7.71875 48 7.59375 47.96875 7.46875 47.90625C7.039063 47.691406 6.878906 47.210938 7.09375 46.78125 Z M 41.21875 43.40625L42.90625 46.78125C43.121094 47.210938 42.960938 47.691406 42.53125 47.90625C42.40625 47.96875 42.28125 48 42.15625 48C41.84375 48 41.558594 47.839844 41.40625 47.53125L39.5625 43.875C39.910156 43.820313 40.285156 43.75 40.6875 43.625C40.855469 43.574219 41.042969 43.476563 41.21875 43.40625Z" />
              </svg>
            </span>
            <p>Furnished</p>
          </div>
        )}
        {listing.parking && (
          <div className="flex w-max justify-center items-center gap-3">
            <span>
              <svg
                className="size-6 fill-fontColor"
                viewBox="0 0 50 50"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path d="M7 6 A 1.0001 1.0001 0 0 0 6.2929688 6.2929688L3.2929688 9.2929688 A 1.0001 1.0001 0 0 0 3.0292969 10.242188L4.0292969 14.242188 A 1.0001 1.0001 0 0 0 5 15L10 15L10 17L8.5976562 17C6.7095541 17 4.9786821 18.068954 4.1308594 19.755859L4.1621094 19.697266L0.73828125 25.515625C0.25551192 26.302311 0 27.206624 0 28.128906L0 37.308594C0 38.783636 1.2163641 40 2.6914062 40L4.0917969 40C4.5721157 42.828207 7.039829 45 10 45C12.960171 45 15.427884 42.828207 15.908203 40L34.091797 40C34.572116 42.828207 37.039829 45 40 45C42.960171 45 45.427884 42.828207 45.908203 40L47 40C48.645455 40 50 38.645455 50 37L50 32.388672C50 29.951489 48.225687 27.858433 45.822266 27.457031L37.494141 26.068359L30.533203 18.777344C29.583575 17.650285 28.183972 17 26.710938 17L26 17L26 15L31 15 A 1.0001 1.0001 0 0 0 31.894531 14.447266L33.894531 10.447266 A 1.0001 1.0001 0 0 0 33.263672 9.0351562L22.263672 6.0351562 A 1.0001 1.0001 0 0 0 22 6L7 6 z M 7.4140625 8L21.865234 8L31.560547 10.644531L30.382812 13L5.78125 13L5.1074219 10.306641L7.4140625 8 z M 12 15L24 15L24 17L12 17L12 15 z M 8.5976562 19L17 19L17 26L2.7734375 26L5.9023438 20.683594L5.9179688 20.652344C6.4281453 19.637236 7.4617586 19 8.5976562 19 z M 19 19L26.710938 19C27.595903 19 28.433534 19.389465 29.003906 20.066406L29.023438 20.089844L34.662109 26L19 26L19 19 z M 2.0078125 28L36.916016 28L45.494141 29.429688C46.946721 29.672283 48 30.915854 48 32.388672L48 37C48 37.554545 47.554545 38 47 38L45.908203 38C45.427884 35.171793 42.960171 33 40 33C37.039829 33 34.572116 35.171793 34.091797 38L15.908203 38C15.427884 35.171793 12.960171 33 10 33C7.039829 33 4.5721157 35.171793 4.0917969 38L2.6914062 38C2.2984484 38 2 37.701552 2 37.308594L2 28.128906C2 28.085622 2.00596 28.043127 2.0078125 28 z M 10 35C12.220375 35 14 36.779625 14 39C14 41.220375 12.220375 43 10 43C7.7796254 43 6 41.220375 6 39C6 36.779625 7.7796254 35 10 35 z M 40 35C42.220375 35 44 36.779625 44 39C44 41.220375 42.220375 43 40 43C37.779625 43 36 41.220375 36 39C36 36.779625 37.779625 35 40 35 z" />
              </svg>
            </span>
            <p>Parking</p>
          </div>
        )}
        <div className="flex w-max justify-center items-center gap-3">
          <span>
            <svg
              className="size-6 fill-fontColor pr-[1px]"
              viewBox="0 -11.47 122.88 122.88"
              version="1.1"
              id="Layer_1"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g>
                <path d="M4.22,67.36h114.31v-4.67c0-1.13-0.22-2.18-0.61-3.12c-0.42-1-1.04-1.89-1.81-2.66c-0.47-0.47-1-0.9-1.57-1.28 c-0.58-0.39-1.2-0.73-1.85-1.02c-1.75-0.38-3.49-0.74-5.22-1.08c-1.74-0.34-3.49-0.66-5.25-0.96c-0.08-0.01-0.14-0.02-0.22-0.04 c-0.89-0.15-1.74-0.29-2.55-0.42c-0.81-0.13-1.67-0.26-2.57-0.4l-0.02,0c-6.12-0.78-12.22-1.38-18.31-1.78 c-6.1-0.4-12.17-0.6-18.2-0.61c-3.58,0-7.15,0.06-10.72,0.2c-3.55,0.14-7.12,0.34-10.69,0.62l-0.02,0 c-3.34,0.31-6.67,0.7-10.01,1.15c-3.33,0.45-6.67,0.98-10.03,1.57l-0.37,0.09c-0.07,0.02-0.14,0.03-0.2,0.03 c-0.06,0.01-0.12,0.01-0.18,0.01c-1.57,0.28-3.18,0.59-4.84,0.92c-1.61,0.32-3.22,0.66-4.82,1.01c-0.4,0.22-0.78,0.47-1.14,0.73 c-0.36,0.27-0.71,0.56-1.02,0.87v0c-0.67,0.67-1.2,1.44-1.56,2.3c-0.34,0.81-0.53,1.71-0.53,2.69V67.36L4.22,67.36z M14.2,0h92.99 c1.21,0,2.37,0.24,3.43,0.68c1.1,0.46,2.09,1.13,2.92,1.95c0.83,0.83,1.5,1.82,1.95,2.92c0.44,1.06,0.68,2.22,0.68,3.43v42.69 c0.51,0.3,1.01,0.63,1.47,0.99c0.52,0.4,1.01,0.82,1.46,1.27c1.16,1.16,2.1,2.51,2.73,4.03c0.6,1.43,0.93,3.02,0.93,4.74v6.09 c0.03,0.1,0.06,0.2,0.08,0.3l0,0.02c0.02,0.13,0.03,0.25,0.03,0.37c0,0.13-0.01,0.26-0.04,0.39l0,0c-0.02,0.1-0.05,0.2-0.08,0.3 v27.66c0,0.58-0.24,1.11-0.62,1.49c-0.38,0.38-0.91,0.62-1.49,0.62h-4.35c-0.49,0-0.94-0.17-1.3-0.45 c-0.36-0.28-0.63-0.68-0.74-1.14c-0.8-2.3-1.61-4.12-2.48-5.54c-0.86-1.4-1.78-2.4-2.84-3.11c-1.07-0.71-2.35-1.16-3.9-1.43 c-1.58-0.28-3.42-0.37-5.61-0.36l-79.76,0.1l-0.04,0c-1.57-0.03-2.86,0.17-3.94,0.59c-1.07,0.42-1.94,1.05-2.66,1.86 c-0.81,0.9-1.49,2.05-2.11,3.39c-0.63,1.37-1.2,2.93-1.77,4.64l0,0c-0.14,0.44-0.42,0.79-0.77,1.04c-0.33,0.24-0.73,0.38-1.14,0.4 c-0.03,0.01-0.06,0.01-0.09,0.01H2.11c-0.58,0-1.11-0.24-1.49-0.62C0.24,98.94,0,98.41,0,97.83V61.52c0-1.57,0.3-3.01,0.84-4.31 c0.58-1.38,1.43-2.61,2.49-3.67c0.3-0.3,0.63-0.6,0.98-0.88c0.3-0.24,0.6-0.47,0.92-0.68V8.89c0-1.21,0.24-2.36,0.68-3.4 c0.46-1.09,1.13-2.07,1.96-2.89c0.83-0.82,1.82-1.47,2.91-1.92C11.84,0.24,12.99,0,14.2,0L14.2,0z M107.19,4.22H14.2 c-0.65,0-1.27,0.13-1.84,0.36c-0.59,0.24-1.11,0.59-1.55,1.02c-0.43,0.42-0.78,0.94-1.02,1.5C9.57,7.65,9.45,8.25,9.45,8.89v41.06 c0.3-0.1,0.6-0.18,0.91-0.26c0.49-0.13,0.98-0.24,1.47-0.32c0.68-0.12,1.42-0.25,2.22-0.39c0.6-0.1,1.24-0.21,1.9-0.31V38.19 c0-1.58,0.32-3.09,0.89-4.47c0.6-1.44,1.47-2.73,2.55-3.81c1.08-1.08,2.37-1.95,3.81-2.55c1.38-0.57,2.89-0.89,4.47-0.89h19.82 c1.58,0,3.09,0.32,4.47,0.89c1.44,0.6,2.73,1.47,3.81,2.55c1.08,1.08,1.95,2.37,2.55,3.81c0.57,1.38,0.89,2.89,0.89,4.47v6.69 c0.7-0.01,1.4-0.01,2.11-0.01v-6.68c0-1.58,0.32-3.09,0.89-4.47c0.6-1.44,1.47-2.73,2.55-3.81c1.08-1.08,2.37-1.95,3.81-2.55 c1.38-0.57,2.89-0.89,4.47-0.89h19.82c1.58,0,3.09,0.32,4.47,0.89c1.44,0.6,2.73,1.47,3.81,2.55c1.08,1.08,1.95,2.37,2.55,3.81 c0.57,1.38,0.89,2.89,0.89,4.47v10.34c0.75,0.11,1.55,0.24,2.41,0.38c0.95,0.15,1.86,0.3,2.74,0.45c0.45,0.08,0.91,0.17,1.37,0.28 c0.29,0.07,0.57,0.14,0.84,0.22V8.98c0-0.64-0.13-1.25-0.36-1.81c-0.24-0.58-0.6-1.1-1.04-1.55c-0.44-0.44-0.97-0.8-1.54-1.04 C108.44,4.35,107.83,4.22,107.19,4.22L107.19,4.22z M43.21,45.56c2.01-0.15,4.03-0.28,6.08-0.38c1.89-0.1,3.8-0.17,5.71-0.22v-6.77 c0-1.01-0.2-1.98-0.57-2.86c-0.38-0.92-0.94-1.74-1.64-2.44c-0.69-0.69-1.52-1.25-2.44-1.64c-0.88-0.37-1.85-0.57-2.86-0.57H27.67 c-1.01,0-1.98,0.2-2.86,0.57c-0.92,0.38-1.74,0.94-2.44,1.64c-0.69,0.69-1.25,1.52-1.64,2.44c-0.37,0.88-0.57,1.85-0.57,2.86V48 c1.62-0.24,3.26-0.46,4.94-0.68c1.81-0.23,3.61-0.44,5.39-0.64c0.69-0.08,1.43-0.17,2.2-0.25c0.72-0.08,1.47-0.15,2.27-0.23 c1.36-0.13,2.71-0.25,4.04-0.36C40.37,45.75,41.77,45.65,43.21,45.56L43.21,45.56z M65.54,44.9c1.21,0.02,2.42,0.05,3.63,0.09 c1.34,0.04,2.68,0.1,4.01,0.16l0.01,0c2.19,0.08,4.33,0.18,6.41,0.3c2.08,0.12,4.11,0.27,6.05,0.44c2.82,0.25,5.55,0.55,8.14,0.9 c2.32,0.32,4.52,0.68,6.58,1.08v-9.68c0-1.01-0.2-1.98-0.57-2.86c-0.38-0.92-0.94-1.74-1.64-2.44c-0.69-0.69-1.52-1.25-2.44-1.64 c-0.88-0.37-1.85-0.57-2.86-0.57H73.05c-1.01,0-1.98,0.2-2.86,0.57c-0.92,0.38-1.74,0.94-2.44,1.64c-0.69,0.69-1.25,1.52-1.64,2.44 c-0.37,0.88-0.57,1.85-0.57,2.86V44.9L65.54,44.9z M118.54,71.59H4.22v24.13h1.43c0.56-1.58,1.14-3.05,1.79-4.36 c0.7-1.4,1.49-2.64,2.45-3.71c1.14-1.28,2.48-2.27,4.09-2.93c1.61-0.65,3.49-0.98,5.75-0.93l79.69-0.1c2.57,0,4.77,0.12,6.69,0.49 c1.95,0.37,3.63,1,5.14,2c1.4,0.93,2.6,2.16,3.68,3.77c1.03,1.54,1.95,3.43,2.83,5.76h0.76V71.59L118.54,71.59z" />
              </g>
            </svg>
          </span>
          <p>
            {listing.bedrooms} {listing.bedrooms > 1 ? "Bedrooms" : "Bedroom"}
          </p>
        </div>
        <div className="flex w-max justify-center items-center gap-3">
          <svg
            className="size-6 fill-fontColor p-[1px]"
            version="1.1"
            id="Layer_1"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 512 512"
          >
            <g>
              <g>
                <path
                  d="M480,234.679H53.333V54.839c0-12.16,11.307-22.827,24.213-22.827h44.587c12.587,0,22.72,10.24,22.827,22.72
			c-20.8,5.227-38.293,24.427-38.293,44.693v28.587c0,5.867,4.8,10.667,10.667,10.667H192c5.867,0,10.667-4.8,10.667-10.667V99.426
			c0-20.587-16.32-39.467-36.373-44.587c0-24.32-19.733-44.16-44.16-44.16H77.547C52.907,10.679,32,30.946,32,54.839v179.84
			c-17.6-0.107-31.893,14.187-32,31.787c0,9.173,3.84,17.813,10.667,23.893v55.893c0,43.413,19.307,80.64,50.56,104.853
			l-17.493,34.773c-2.667,5.227-0.533,11.627,4.8,14.293c5.227,2.667,11.627,0.533,14.293-4.8l16.427-32.747
			c21.547,11.52,45.653,17.493,70.08,17.28h213.333c24.427,0.213,48.533-5.76,70.08-17.28l16.427,32.747
			c2.667,5.227,9.067,7.36,14.293,4.8c5.227-2.56,7.36-9.067,4.8-14.293l-17.493-34.88c31.253-24.107,50.56-61.44,50.56-104.853
			v-55.893c6.72-5.867,10.667-14.507,10.667-23.573C512,248.973,497.707,234.679,480,234.679z M155.627,74.679
			c12.693,0,25.707,12.48,25.707,24.747v17.92H128v-17.92C128,87.586,142.4,74.679,155.627,74.679z M480,346.253
			c0,64.107-50.453,112.427-117.333,112.427H149.333C82.453,458.679,32,410.359,32,346.253v-47.573h448V346.253z M480,277.346H32.32
			c-5.333,0-10.133-3.84-10.88-9.067c-0.96-6.613,4.16-12.267,10.56-12.267h447.68c5.333,0,10.133,3.84,10.88,9.067
			C491.52,271.693,486.4,277.346,480,277.346z"
                />
              </g>
            </g>
          </svg>
          <p>
            {listing.bathrooms}{" "}
            {listing.bathrooms > 1 ? "Bathrooms" : "Bathroom"}
          </p>
        </div>
      </div>
      <span className="my-3 border-t"></span>
      <div className="my-2">
        <p className="font-medium text-lg sm:text-2xl">About this place</p>
        <p className="font-normal text-md sm:text-lg text-justify my-4">
          {listing.description}
        </p>
      </div>
    </div>
  );
}
